\section{Evaluation}
\label{sec:eval}

In this section we describe the performance of evaluation of \sys{}.
%
We first evaluate the end-to-end performance of the \sys{}
applications described in Section~\ref{sec:system}, relative to
implementations that simply trade off security for the features the
apps provide.
%
Then, we measure the performance impact of \sys{} on existing browser
features and the additional overhead when confinement-mode is actually
enabled.
%
All our measurements were conducted on a 4-core i7-2620M machine
running GNU/Linux 3.11, with 16GB of RAM.
%
Our patches are applied to Firefox versions 26, and Chromium version
31.
%


\subsection{Macro benchmarks}
\label{sec:eval:macro}

We implemented all the applications described in
Section~\ref{sec:system}.
%
Below we measure the performance of some of these applications on our
modified Firefox browser.
%
For comparison, we port the applications by removing any security
related checks and measure their performance on the unmodified
(vanilla) version of Firefox.

\paragraph{Password-strength checker}
%% Vanilla: just run script in worker
%% Firefox: With \sys{} it take 59.5ms, Vanilla: 61.4
%% Chome: With \sys{} it take 80.5ms, Vanilla:  71.5
%
We implemented the password-strength checker of
Section~\ref{sec:system:worker}, using the checker script
from~\cite{checker1} to perform the actual strength checking.
%
Our end-to-end evaluation measures the average duration it takes to
create a new labeled worker (with a fresh principal), fetch (with XHR)
the checker script, which is 8KB long, and perform the actual strength
checking on a password 16-characters in length.
%
We averaged the duration of 10 runs (without caching the script).
%
In Firefox the amount of time it takes to perform the strength
checking is 59.5ms.
%
This figure, though predominantly dominated by network delay, is
roughly 3\% faster than the strength checker running running in a
``normal'' worker on a vanilla, unmodified, browser (which
additionally caches the worker script).
%
We attribute our speedup to the fact that creating and communicating
with labeled workers is faster than existing workers (see
micro-benchmarks, below), and believe that caching the checker script
would lead to additional speedup gains.


\paragraph{Encrypted web-based editor}
%% Vanilla: removed the sandbox stuff.
%% Firefox: With \sys{} it take 114.8, Vanilla: 100.2
%% Chome: With \sys{} it take 248.1, Vanilla; 257.8

We implemented a simple document editor with an encryption layer as
described in Section~\ref{sec:system:iframe}.
%
(This application is similar to---but slightly simpler than---the
password manager, hence we do not report any measurements for the
password manager.)
%
Our benchmark measures the end-to-end time it takes to load the
application, carry out the protocol described in
Section~\ref{sec:system:iframe}  and ``encrypt'' a 4KB document with
the NULL-cipher.
%
We measured the \sys{} application to take 114.8ms on the modified
version of Firefox, while a simplified, insecure version of the app,
running on vanilla Firefox took 100ms.
%
We note that our figure accounts for the amount of time it takes to
load the document editor page, which itself loads the encryption layer
as an iframe, which further loads the actual editor.
%
We attribute the (small) 14.8ms slowdown to both the label checks
performed by \sys{} and security layer added on top of the insecurity
application; in the vanilla case, we removed the label operations and
authentication layer (used to ensure that the label of the innermost
iframe is sufficiently high).


\paragraph{Third-party mashup}
%% Firefox: With \sys{} it take 10.7ms, Vanilla:  10.7ms
%% Chrome: With \sys{} it take 15ms, Vanilla:  17ms
%% 
%% Vanilla: just remove sandbox stuff + add CORS

We implemented a very simple third-party mashup application in which
the integrator makes an XHR request to two unaffiliated origins, each
of which produces a response containing a (27 byte) JSON object with a
number property.
%
The integrator parses the JSON objects, sums the numbers, and adds the
sum to the document body.
%
The corresponding vanilla application is identical, but uses the
normal XHR object and requires the origins to set CORS headers permit
the JSON responses to be inspected by any content from any origin.
%
We measured the latency of the application to be 10.7ms in both cases.
%
Of course, the \sys{} application has the advantage of treating the
received content as sensitive (and thus required setting proper CSP
and iframe sandbox flags) as opposed to the CORS-based approach that
would allow the integrator to arbitrarily leak the sum.

\paragraph{Untrusted libraries}
%% Vanilla: incorporate script directly, no sandboxes.
%% As page confine:
%% Firefox: With \sys{} it take 164.8ms, Vanilla:  160.2ms
%% As extension
%% Firefox: With \sys{} it take 224.4ms

Finally, we measure the load time of a banking page that incorporates
the untrusted Phone2Links library using two different design patterns.
%
In the first case, the bank trusted code is placed a labeled worker,
with access to the page document and privilege, following the pattern
of Section~\ref{sec:system:script}; in the second case, the untrusted
code is treated as an extension and placed in an labeled worker, by
our extension loader (implemented as an actual Firefox extension),
with no privileges, following the pattern of
Section~\ref{sec:system:extension}.
%
In both cases the bank page contains an iframe with the sensitive
(labeled) bank statement, both of which load the jQuery and
Phone2Links libraries.
%
The latter library additionally performs XHR requests in attempt to
leak the page content.

We measured the total load time of the page. In the first case, the
duration was 164.8ms, which is 4.6ms longer than an insecure version
of the application running on vanilla Firefox.
%
We remark that this additional slowdown is negligible considering that
the application contains mixed-sensitivity content (the main banking
page is public, while the bank statement iframe is labeled with the
origin of the page), which \sys{} prevents the malicious library from
leaking; in the vanilla case, the library trivially leaks the bank
statement.

When incorporating Phone2Links as an extension, the measured page load
time was 224.4ms.
%
Since there is not obvious approach to integrating untrusted
extensions with existing browsers, we do not compare against a vanilla
implementation.
%
Rather, we compare against the version of the application with
Phone2Links integrated as a library (above): the extension approach is
roughly 1.4 times slower, a slowdown we attribute to the fact that the
extension is loaded by our loader, which is, in turn, an AddOn-SDK
extension loaded by Firefox.
%
Finally, we remark that while the load time is not small, it also does
not impose a huge performance penalty on the vanilla page.
%
Moreover, this figure can easily be improved by optimizing our
extension loader or implementing it as a traditional extension (which
is faster than using the AddOn-SDK).



Vanilla: incorporate script directly, no sandboxes.

As page confine:
Firefox: With \sys{} it take 164.8ms, Vanilla:  160.2ms

As extension
Firefox: With \sys{} it take 224.4ms

\subsection{Micro benchmarks}
\label{sec:eval:micro}

\newcommand*\rot{\rotatebox{90}}

\begin{table}
\centering
\begin{tabular}{l |c|c|c|c|c|c }
\toprule
                   & \multicolumn{3}{c}{\textbf{Firefox}}
                   & \multicolumn{3}{c}{\textbf{Chrome}} \\
                   & \rot{vanilla}   &
                     \rot{unlabeled} &
                     \rot{labeled}   &
                     \rot{vanilla}   &
                     \rot{unlabeled} &
                     \rot{labeled}   
\\\midrule%--------------------------------------------------------------------
% cost of creating an iframe                                         
New iframe         &   13.27  &  13.3   & 13.97   &   50.63 &   48.73 &  51.77 
\\\hline%----------------------------------------------------------------------
% cost of creating a worker                                          
New worker         &  20.53  &   21.24 &  1.62   &  18.94  &  18.87  & 3.27
\\\midrule%--------------------------------------------------------------------
% cost of labeled postMessage                                        
Iframe ping-pong   &  0.086  &  0.084  &  0.092  &  0.042  &  0.042  &  0.042
\\\hline%----------------------------------------------------------------------
% cost of performing XHR                                             
XHR ping-pong      &  3.33   &   3.48  &  3.49   &  7.0    &  7.4    & 7.2
\\\hline%----------------------------------------------------------------------
% cost of worker ping-pong                                           
Worker ping-pong   &  0.059  &   0.055 &  0.037  &  0.071  &  0.070  & 0.030
\\\midrule%--------------------------------------------------------------------
% cost of setting current label                                      
Set label          &  --     &  \multicolumn{2}{c|}{0.0014} &   --   
                             &  \multicolumn{2}{c }{0.0018}
\\\hline%-------------------------------------------------------------------------------------------------
% cost of setting current label                                                                   
Get label          &  --     &  \multicolumn{2}{c|}{0.0003} &   --   
                             &  \multicolumn{2}{c }{0.0008}
\\\hline%-------------------------------------------------------------------------------------------------
% cost of comparing labels                                                                        
Label subsumes     &  --     &  \multicolumn{2}{c|}{0.0012} &   --   
                             &  \multicolumn{2}{c }{0.0004}
\\\bottomrule
\end{tabular}
\caption{\label{microbench} Micro-benchmarks, in milliseconds (ms).
%%Vanilla denotes stock browser measurements, our modified browsers with
%%confinement-mode turned off and on are respectively
%%are denoted by unlabeled and labeled.
}
\end{table}

Table~\ref{microbench} shows our micro-benchmarks for the stock
browsers (vanilla), our modified browsers with confinement-mode turned
off (unlabeled), and confinement-mode enabled (labeled).
%
We measure the cost of creating various compartments (workers and
iframes), sending messages between various entities
(compartments and network), and common label operations.

The performance impact of creating an iframe or worker is
within 3.5\% and 2.5\% of the vanilla implementations on Firefox and
Chromium, respectively.
%
In absolute terms, \sys{} adds, on average, less than 1ms
latency.
%
As also shown in the table, the \sys{} labeled workers provide
programmers with a considerably more light weight concurrency
primitive: creating a labeled worker is roughly 12 and 6 times faster
than a corresponding unlabeled worker.

%
The iframe, worker and XHR ping-pong measurements evaluate the cost of
sending and receiving a message (\js|PING| and \js|PONG|,
respectively) across iframes, workers, and network, respectively.
%
In all cases, the performance impact of \sys{} is negligible when
compared to an unmodified, vanilla browser.
%
In the case of XHR, the performance impact on the
(local-network test) is less than 5.5\% for both Firefox and Chromium,
a less than 0.5ms delay.
%
In most of the other cases the sub 0.1ms differences can be
attributed to noise.
%
The only interesting case is that of communication with
labeled-workers; as with creating labeled workers, communication with
a labeled workers is roughly 2 times faster than a corresponding
vanilla worker.

Finally, getting the current label, setting the current label and
performing a label comparison (subsumes) are all on the order of a
microsecond.
%
These measurements, as in the case of sending labeled messages, use
a single label: the public label.
%
Hence, when considering more complex labels, we expect the performance
impact of labels to naturally be higher.
%
For a bounded random label comparison, with at most 5 principals, we
measured a 5\% performance degradation.
%
This measurement serves as a reasonable point for real application,
which are likely to only contain a handful of principals.
%
While the 5\% slowdown (for a rare operation) is mostly negligible, we
note there is much room for speeding up label comparisons since our
label implementation has not yet been optimized.

%%Comparing the 
%%Similarly, the performance impact of labels is under  5\%  in almost
%%every case.

